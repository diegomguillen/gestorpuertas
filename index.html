<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Puertas</title>

    <!-- --- Iconos y Meta Tags de App --- -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîë</text></svg>">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/2563EB/FFFFFF?text=GP&font=inter">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Gestor">
    <!-- --- Fin de Tags --- -->

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .page-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
				/* Animaci√≥n para el fondo (oscurecerse) */
				@keyframes modalBackdropIn {
						from { opacity: 0; }
						to { opacity: 1; }
				}

				/* Animaci√≥n para el contenido (aparecer y escalar) */
				@keyframes modalContentIn {
						from { opacity: 0; transform: scale(0.95); }
						to { opacity: 1; transform: scale(1); }
				}
        .contacts-unsupported .contact-picker-button { display: none; }
				/* Aplicar animaci√≥n al fondo de los modales cuando se muestran */
				#sync-modal.flex, #form-modal.flex, #loading-modal.flex {
						animation: modalBackdropIn 0.5s ease-out;
				}

				/* Aplicar animaci√≥n al contenido (la tarjeta blanca) de los modales */
				#sync-modal > div, #form-modal > div, #loading-modal > div {
						animation: modalContentIn 0.5s ease-out;
				}
				.form-tab {
						padding: 8px 16px;
						border-bottom: 2px solid transparent;
						cursor: pointer;
						color: #6B7280; /* text-gray-500 */
				}
				.form-tab-active {
						border-color: #4F46E5; /* border-indigo-600 */
						color: #4F46E5; /* text-indigo-600 */
						font-weight: 500;
				}
        /* Estilos para el Modal */
        #sync-modal, #form-modal, #loading-modal { display: none; }
        #sync-modal.flex, #form-modal.flex, #loading-modal.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Contenedor principal de la aplicaci√≥n -->
    <div class="max-w-lg mx-auto bg-white min-h-screen shadow-lg flex flex-col">

        <!-- √Årea de contenido principal (cambia seg√∫n la pesta√±a) -->
        <main class="flex-grow pb-20">
            
            <!-- ============================================= -->
            <!-- P√ÅGINA 1: ACCIONES (Por defecto) -->
            <!-- ============================================= -->
            <div id="page-acciones" class="page-content p-5">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Permisos</h1>
                <p class="text-gray-700 mb-6">Selecciona una acci√≥n principal para generar un comando de configuraci√≥n que enviar√°s por sms a la puerta.</p>
                <div class="space-y-4">
                    <button onclick="startWorkflow('ADD')" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="flex-shrink-0 w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 text-left">Asignar permisos</h2>
                            <p class="text-gray-500 text-sm text-left">Asignar permisos a usuarios para una puerta y horario.</p>
                        </div>
                    </button>
                    <button onclick="startWorkflow('DEL')" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="flex-shrink-0 w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 11h-6" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 text-left">Revocar permisos</h2>
                            <p class="text-gray-500 text-sm text-left">Revocar permisos a usuarios para una puerta y horario.</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- P√ÅGINA 1.1: WORKFLOW (Oculta) -->
            <!-- ============================================= -->
            <div id="page-workflow" class="page-content p-5 hidden">
                <div class="flex items-center mb-6">
                    <button onclick="goBack('page-acciones')" class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    </button>
                    <h1 id="workflow-title" class="text-2xl font-bold text-gray-900 ml-3">Generar SMS</h1>
                </div>
                <div class="space-y-6">
                    <div>
                        <label for="workflow-select-puerta" class="block text-sm font-medium text-gray-700 mb-1">Paso 1: Seleccionar Puerta</label>
                        <select id="workflow-select-puerta" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Rellenado por JS -->
                        </select>
                    </div>
                    <div>
                        <label for="workflow-select-horario" class="block text-sm font-medium text-gray-700 mb-1">Paso 2: Seleccionar Horario</label>
                        <select id="workflow-select-horario" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Rellenado por JS -->
                        </select>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-gray-700">Paso 3: Seleccionar Usuarios</label>
                            <span id="workflow-user-count" class="text-sm font-medium text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full">0 / 10</span>
                        </div>
                        <input id="workflow-search" type="text" placeholder="Buscar por alias o tel√©fono..." class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div id="workflow-user-list" class="max-h-60 overflow-y-auto space-y-3 p-3 bg-gray-50 rounded-lg border">
                            <!-- Rellenado por JS -->
                        </div>
                    </div>
                    <button id="workflow-action-button" onclick="generateSmsAndConfirm()" class="w-full p-4 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-all">
                        Generar SMS
                    </button>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- P√ÅGINA 2: ADMINISTRAR (Oculta) -->
            <!-- ============================================= -->
            <div id="page-administrar" class="page-content p-5 hidden">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Administrar</h1>
								<p class="text-gray-700 mb-6">Gestiona tus datos maestros. Esta informaci√≥n se guarda 
										<span class="font-medium bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded-md">
												solo en tu dispositivo
										</span>, haz copia de seguridad por si borras los datos del navegador(cache, cookies,..).
								</p>
                <div class="space-y-4">
                    <button onclick="showSubPage('page-admin-puertas')" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all">
                        <div class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0v4M5 9h14l1 12H4L5 9z" /></svg></div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 text-left">Gestionar Puertas</h2>
                            <p class="text-gray-500 text-sm text-left">A√±ade o edita tus puertas y sus ID (contrase√±as).</p>
                        </div>
                    </button>
                    <button onclick="showSubPage('page-admin-horarios')" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all">
                        <div class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 text-left">Gestionar Grupos Horarios</h2>
                            <p class="text-gray-500 text-sm text-left">Crea plantillas de d√≠as y horas para los permisos.</p>
                        </div>
                    </button>
                    <button onclick="showSubPage('page-admin-usuarios')" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all">
                        <div class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg></div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 text-left">Gestionar Usuarios</h2>
                            <p class="text-gray-500 text-sm text-left">A√±ade o edita los alias y tel√©fonos de tus usuarios.</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- P√ÅGINAS 2.x: Sub-p√°ginas de Admin -->
            <!-- ============================================= -->
            
            <!-- 2.1: Admin Puertas -->
            <div id="page-admin-puertas" class="page-content p-5 hidden relative" style="min-height: 80vh;">
                <div class="flex items-center mb-6">
                    <button onclick="goBack('page-administrar')" class="p-2 rounded-full hover:bg-gray-100 text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                    <h1 class="text-2xl font-bold text-gray-900 ml-3">Gestionar Puertas</h1>
                </div>
                <div id="puertas-list" class="space-y-3">
                    <!-- Rellenado por JS -->
                </div>
                <button onclick="showForm('puertas')" class="absolute bottom-24 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>

            <!-- 2.2: Admin Horarios -->
            <div id="page-admin-horarios" class="page-content p-5 hidden relative" style="min-height: 80vh;">
                <div class="flex items-center mb-6">
                    <button onclick="goBack('page-administrar')" class="p-2 rounded-full hover:bg-gray-100 text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                    <h1 class="text-2xl font-bold text-gray-900 ml-3">Gestionar Grupos Horarios</h1>
                </div>
                <div id="grupos-list" class="space-y-3">
                    <!-- Rellenado por JS -->
                </div>
                <button onclick="showForm('gruposHorarios')" class="absolute bottom-24 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>

            <!-- 2.3: Admin Usuarios -->
            <div id="page-admin-usuarios" class="page-content p-5 hidden relative" style="min-height: 80vh;">
                <div class="flex items-center mb-6">
                    <button onclick="goBack('page-administrar')" class="p-2 rounded-full hover:bg-gray-100 text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                    <h1 class="text-2xl font-bold text-gray-900 ml-3">Gestionar Usuarios</h1>
                </div>
                <input type="text" id="admin-user-search" placeholder="Buscar por alias o tel√©fono..." class="w-full p-3 border border-gray-300 rounded-lg mb-4">
                <div id="usuarios-list" class="space-y-3">
                    <!-- Rellenado por JS -->
                </div>
                <button onclick="showForm('usuarios')" class="absolute bottom-24 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
            
            <!-- 2.5: Detalle de Usuario -->
            <div id="page-user-detail" class="page-content p-5 hidden">
                 <div class="flex items-center mb-6">
                    <button onclick="goBack('page-admin-usuarios')" class="p-2 rounded-full hover:bg-gray-100 text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                    <h1 class="text-2xl font-bold text-gray-900 ml-3">Detalle de Usuario</h1>
                </div>
                <div class="p-4 bg-white rounded-lg shadow border">
                    <h2 id="detail-user-alias" class="text-xl font-semibold text-gray-900"></h2>
                    <p id="detail-user-tel" class="text-md text-gray-600 mb-4"></p>
                    <hr class="my-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Permisos Asignados (en esta app)</h3>
										<div id="detail-user-permisos-recurrentes" class="space-y-3 mb-6">
										</div>

										<h3 class="text-lg font-semibold text-gray-800 mb-3">Permisos de Fecha √önica</h3>
										<div id="detail-user-permisos-timestamp" class="space-y-3">
										</div>
                </div>
            </div>

            <!-- ============================================= -->
            <!-- P√ÅGINA 3: COPIA DE SEGURIDAD (Oculta) -->
            <!-- ============================================= -->
            <div id="page-copia-seguridad" class="page-content p-5 hidden">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Copia de Seguridad</h1>
                <p class="text-gray-600 mb-6">Guarda o restaura todos tus datos (puertas, horarios, usuarios) desde un fichero.</p>
								<div class="mb-8">
										<h2 class="text-xl font-semibold text-gray-800 mb-3">Exportar</h2>
										<button onclick="exportData()" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all">
												<div class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
												</div>
												<div>
														<h2 class="text-lg font-semibold text-gray-900 text-left">Descargar Copia</h2>
														<p class="text-gray-500 text-sm text-left">Guardar fichero .json, gu√°rdalo a buen recaudo por si pierdes el dispositivo.</p>
												</div>
										</button>
								</div>
								<div>
										<h2 class="text-xl font-semibold text-gray-800 mb-3">Importar</h2>
										<div class="mb-4 p-4 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg">
												<span class="font-semibold">Atenci√≥n:</span> Los datos actuales se borrar√°n y quedar√°n los de la copia.
										</div>
										<input type="file" id="import-file" class="hidden" accept="application/json" onchange="importData(event)">
										<button onclick="document.getElementById('import-file').click()" class="w-full flex items-center space-x-4 p-5 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 transition-all">
												<div class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
												</div>
												<div>
														<h2 class="text-lg font-semibold text-gray-900 text-left">Cargar Copia</h2>
														<p class="text-gray-500 text-sm text-left">Restaurar tus datos desde un fichero .json.</p>
												</div>
										</button>
								</div>
            </div>

        </main>

        <!-- ============================================= -->
        <!-- BARRA DE NAVEGACI√ìN INFERIOR (TAB BAR) -->
        <!-- ============================================= -->
        <footer class="fixed bottom-0 left-0 w-full max-w-lg mx-auto bg-white border-t border-gray-200">
            <nav class="flex justify-around p-3">
                <button id="tab-acciones" onclick="navigateTo('page-acciones', 'tab-acciones')" class="tab-button flex flex-col items-center w-full p-2 rounded-lg text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1zm5 0a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                    <span class="text-xs font-medium mt-1">Home</span>
                </button>
                <button id="tab-administrar" onclick="navigateTo('page-administrar', 'tab-administrar')" class="tab-button flex flex-col items-center w-full p-2 rounded-lg text-gray-500">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
												<path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
												<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
										</svg>
                    <span class="text-xs font-medium mt-1">Admin</span>
                </button>
                <button id="tab-copia-seguridad" onclick="navigateTo('page-copia-seguridad', 'tab-copia-seguridad')" class="tab-button flex flex-col items-center w-full p-2 rounded-lg text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    <span class="text-xs font-medium mt-1">Backup</span>
                </button>
            </nav>
        </footer>
    </div>

    <!-- ============================================= -->
    <!-- MODALES (Ocultos por defecto) -->
    <!-- ============================================= -->

    <!-- Modal de Sincronizaci√≥n -->
    <div id="sync-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-5">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Comando SMS Generado</h3>
            <p class="text-sm text-gray-600 mb-4">La aplicaci√≥n de SMS se ha abierto. ¬øHas enviado el comando?</p>
            <p class="text-sm text-gray-600 mb-6">Pulsa "S√≠" para guardar este cambio en la memoria de la app.</p>
            <div class="space-y-3">
                <button id="sync-button-yes" class="w-full p-3 bg-indigo-600 text-white rounded-lg font-medium">
                    S√≠, Sincronizar
                </button>
                <button id="sync-button-no" class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg font-medium">
                    No, Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Formulario Gen√©rico (para A√±adir/Editar) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-5">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="form-title" class="text-lg font-medium text-gray-900 mb-4"></h3>
            <form id="generic-form" class="space-y-4">
                <!-- Contenido del formulario rellenado por JS -->
            </form>
        </div>
    </div>
    
    <!-- Modal de Carga -->
    <div id="loading-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-5">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Cargando...</h3>
            <p class="text-sm text-gray-600">Inicializando base de datos...</p>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- JAVASCRIPT (Toda la l√≥gica de la app) -->
    <!-- ============================================= -->
    <script>
        // --- ESTADO GLOBAL Y NAVEGACI√ìN ---
        let currentPageId = 'page-acciones';
        let currentActiveTabId = 'tab-acciones';
        let db;
        let currentAction = 'ADD'; // 'ADD' o 'DEL'
        let currentWorkflow = {
            puertaId: null,
            grupoId: null,
            usuarios: [] // Array de idUsuario
        };
        let pendingSyncData = null; // Guarda los datos para la sincronizaci√≥n

        // Historial de navegaci√≥n simple para "Atr√°s"
        let pageHistory = ['page-acciones'];

        function navigateTo(pageId, tabId) {
            // No hacer nada si ya estamos en esta pesta√±a
            if (pageId === pageHistory[pageHistory.length - 1] && pageId !== 'page-acciones') return;
            
            showSubPage(pageId, true); // true = es una navegaci√≥n de pesta√±a principal
            
            // Actualizar estado visual de las pesta√±as
            document.getElementById(currentActiveTabId).classList.remove('text-indigo-600');
            document.getElementById(currentActiveTabId).classList.add('text-gray-500');
            document.getElementById(tabId).classList.add('text-indigo-600');
            document.getElementById(tabId).classList.remove('text-gray-500');
            currentActiveTabId = tabId;
        }

        function showSubPage(pageId, isTabNavigate = false) {
            // Ocultar p√°gina anterior
            const oldPage = document.getElementById(currentPageId);
            if (oldPage) oldPage.classList.add('hidden');
            
            // Mostrar p√°gina nueva
            const newPage = document.getElementById(pageId);
            if(newPage) {
                newPage.classList.remove('hidden');
                // Re-aplicar animaci√≥n
                newPage.style.animation = 'none';
                newPage.offsetHeight; // trigger reflow
                newPage.style.animation = null; 
            }
            
            currentPageId = pageId;

            // Gestionar historial de navegaci√≥n
            if (isTabNavigate) {
                pageHistory = [pageId]; // Resetear historial al cambiar de pesta√±a
            } else {
                if (pageHistory[pageHistory.length - 1] !== pageId) {
                    pageHistory.push(pageId);
                }
            }
            
            // Disparar renders espec√≠ficos al mostrar una p√°gina
            switch(pageId) {
                case 'page-admin-puertas': renderPuertasList(); break;
                case 'page-admin-horarios': renderGruposList(); break;
                case 'page-admin-usuarios': renderUsuariosList(); break;
                case 'page-workflow': renderWorkflowPage(); break;
            }
        }
        
        function goBack(fallbackPage) {
            pageHistory.pop(); // Quitar la p√°gina actual
            let prevPageId = pageHistory[pageHistory.length - 1];
            
            if (!prevPageId) {
                prevPageId = fallbackPage || 'page-acciones'; // Fallback
            }
            
            // Ocultar p√°gina actual
            const oldPage = document.getElementById(currentPageId);
            if (oldPage) oldPage.classList.add('hidden');
            
            // Mostrar p√°gina previa
            const newPage = document.getElementById(prevPageId);
            if(newPage) {
                newPage.classList.remove('hidden');
                newPage.style.animation = 'none';
                newPage.offsetHeight;
                newPage.style.animation = null; 
            }
            
            currentPageId = prevPageId;
            
            // Disparar renders al volver
            switch(prevPageId) {
                case 'page-admin-puertas': renderPuertasList(); break;
                case 'page-admin-horarios': renderGruposList(); break;
                case 'page-admin-usuarios': renderUsuariosList(); break;
            }
        }
        
        function showLoading(message) {
            document.getElementById('loading-modal').querySelector('p').textContent = message;
            document.getElementById('loading-modal').classList.add('flex');
        }
        
        function hideLoading() {
            document.getElementById('loading-modal').classList.remove('flex');
        }

        // --- L√ìGICA DE BASE DE DATOS (IndexedDB) ---
        function initDB() {
            showLoading('Inicializando base de datos...');
            const request = indexedDB.open("GestorPuertasDB", 1);

            request.onerror = (event) => {
                console.error("Error al abrir IndexedDB:", event);
                alert("Error: No se pudo inicializar la base de datos.");
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // 1. Puertas
                if (!db.objectStoreNames.contains('puertas')) {
                    db.createObjectStore('puertas', { keyPath: 'id' });
                }
                
                // 2. Grupos Horarios
                if (!db.objectStoreNames.contains('gruposHorarios')) {
                    db.createObjectStore('gruposHorarios', { keyPath: 'id' });
                }
                
                // 3. Usuarios
                if (!db.objectStoreNames.contains('usuarios')) {
                    db.createObjectStore('usuarios', { keyPath: 'idUsuario' });
                }
                
                // 4. Permisos (La "memoria" de la app)
                if (!db.objectStoreNames.contains('permisosAsignados')) {
                    // CORREGIDO: A√±adido keyPath 'id'
                    const permisosStore = db.createObjectStore('permisosAsignados', { keyPath: 'id', autoIncrement: true });
                    // √çndice para buscar permisos por Usuario+Puerta+Grupo
                    permisosStore.createIndex('permisoIdx', ['idUsuario', 'idPuerta', 'idGrupo'], { unique: true });
                    // √çndices para buscar solo por usuario
                    permisosStore.createIndex('usuarioIdx', 'idUsuario', { unique: false });
                    // CORREGIDO: A√±adidos √≠ndices faltantes para el borrado
                    permisosStore.createIndex('puertaIdx', 'idPuerta', { unique: false });
                    permisosStore.createIndex('grupoIdx', 'idGrupo', { unique: false });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Base de datos abierta con √©xito.");
                hideLoading();
                // Comprobar compatibilidad de API de Contactos
                if (!('contacts' in navigator && 'ContactsManager' in window)) {
                    document.body.classList.add('contacts-unsupported');
                }
            };
        }
		/**
		 * Convierte una cadena de fecha/hora (del input) a un formato delimitado
		 * @param {string} dateString - Ej: "2025-11-07T18:00"
		 * @returns {string} - Ej: "25;11;7;18;0" (A√±o;Mes;D√≠a;Hora;Min)
		 */
		function formatForPICDelimited(dateString) {
			const d = new Date(dateString);
			if (isNaN(d)) return "00;0;0;0;0"; // Caso de error

			const yy = d.getFullYear().toString().slice(-2); // '25'
			const mm = (d.getMonth() + 1).toString(); // '11' (getMonth() es 0-11)
			const dd = d.getDate().toString(); // '7'
			const hh = d.getHours().toString(); // '18'
			const mi = d.getMinutes().toString(); // '0'

			return `${yy};${mm};${dd};${hh};${mi}`;
		}		

        // --- FUNCIONES CRUD (Administrar) ---
        
        
				// Formulario gen√©rico
        function showForm(storeName, id = null) {
            const form = document.getElementById('generic-form');
            const title = document.getElementById('form-title');
            form.innerHTML = ''; // Limpiar formulario
            form.dataset.store = storeName;
            form.dataset.id = id || '';
            
            let html = '';
            
            if (storeName === 'puertas') {
                title.textContent = id ? 'Editar Puerta' : 'Nueva Puerta';
                const item = id ? getFromDb('puertas', id).then(p => fillForm(p)) : fillForm(null);
                function fillForm(p) {
                    form.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Alias de la Puerta</label>
                            <input type="text" id="form-aliasPuerta" value="${p?.aliasPuerta || ''}" required class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ID de Puerta (Contrase√±a SMS)</label>
                            <input type="text" id="form-idPuerta_password" value="${p?.idPuerta_password || ''}" required class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                        </div>
                        <!-- CAMBIO: Eliminado el campo Tel√©fono -->
                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="button" onclick="closeForm()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
                        </div>
                    `;
                }
                
            } else if (storeName === 'gruposHorarios') {
                title.textContent = id ? 'Editar Grupo Horario' : 'Nuevo Grupo Horario';
                const item = id ? getFromDb('gruposHorarios', id).then(g => fillForm(g)) : fillForm(null);
                function fillForm(g) {
                    const dias = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                    const diasHtml = dias.map((dia, index) => {
                        const isChecked = g?.dias?.includes(index);
                        return `
                            <button type="button" data-day="${index}" class="dia-toggle w-10 h-10 rounded-full border ${isChecked ? 'border-blue-500 bg-indigo-100 text-indigo-700' : 'border-gray-300 text-gray-500'} font-bold">
                                ${dia}
                            </button>
                        `;
                    }).join('');
                    
										// Definir qu√© pesta√±a est√° activa. Si es un item existente, usar su tipo.
                    // Si es nuevo, por defecto 'recurrent'.
                    const activeType = g ? (g.type || 'recurrent') : 'recurrent';

                    form.innerHTML = `
                        <input type="hidden" id="form-group-type" value="${activeType}">
                        
                        <div class="flex border-b mb-4">
                            <div id="tab-recurrent" class="form-tab ${activeType === 'recurrent' ? 'form-tab-active' : ''}" onclick="switchGroupFormTab('recurrent')">
                                Recurrente
                            </div>
                            <div id="tab-timestamp" class="form-tab ${activeType === 'timestamp' ? 'form-tab-active' : ''}" onclick="switchGroupFormTab('timestamp')">
                                Fecha √önica
                            </div>
                        </div>

                        <div id="form-content-recurrent" class="space-y-4 ${activeType === 'recurrent' ? '' : 'hidden'}">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Descripci√≥n (Opcional)</label>
                                <input type="text" id="form-descGrupo-recurrent" value="${g?.descGrupo || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">D√≠as</label>
                                <div class="flex justify-between mt-2">${diasHtml}</div>
                            </div>
                            <div class="flex space-x-4">
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700">Hora Inicio</label>
                                    <input type="time" id="form-horaInicio" value="${g?.horaInicio || '08:00'}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                                </div>
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700">Hora Fin</label>
                                    <input type="time" id="form-horaFin" value="${g?.horaFin || '15:00'}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                                </div>
                            </div>
                        </div>

                        <div id="form-content-timestamp" class="space-y-4 ${activeType === 'timestamp' ? '' : 'hidden'}">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                                <input type="text" id="form-descGrupo-timestamp" value="${g?.descGrupo || ''}" required class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Fecha y Hora de Inicio</label>
                                <input type="datetime-local" id="form-fechaInicio" value="${g?.fechaInicio || ''}" required class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Fecha y Hora de Fin</label>
                                <input type="datetime-local" id="form-fechaFin" value="${g?.fechaFin || ''}" required class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="button" onclick="closeForm()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
                        </div>
                    `;
                    // A√±adir listeners a los botones de d√≠a
                    form.querySelectorAll('.dia-toggle').forEach(btn => {
                        btn.addEventListener('click', () => {
                            btn.classList.toggle('border-blue-500');
                            btn.classList.toggle('bg-indigo-100');
                            btn.classList.toggle('text-indigo-700');
                            btn.classList.toggle('border-gray-300');
                            btn.classList.toggle('text-gray-500');
                        });
                    });
                }
                
            } else if (storeName === 'usuarios') {
                title.textContent = id ? 'Editar Usuario' : 'Nuevo Usuario';
                const item = id ? getFromDb('usuarios', id).then(u => fillForm(u)) : fillForm(null);
                function fillForm(u) {
                    form.innerHTML = `
                        <button onclick="loadContact()" type="button" class="contact-picker-button w-full flex items-center justify-center space-x-2 p-3 bg-white text-gray-700 text-md font-medium rounded-lg shadow-sm border border-gray-300 hover:bg-gray-50 transition-all mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-2.146M17 20H7m10 0v-2c0-.828-.08-1.623-.23-2.396M7 20H3v-2a3 3 0 015.356-2.146M7 20v-2c0-.828.08-1.623.23-2.396m1.113-10.053A5.002 5.002 0 0113 5c1.553 0 2.94 1.258 3.21.688A5.002 5.002 0 0113 5V5.002zM13 5c-1.553 0-2.94-1.258-3.21-.688A5.002 5.002 0 0013 5V5.002z" /></svg>
                            <span>Cargar desde Contactos</span>
                        </button>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Alias del Usuario</label>
                            <input type="text" id="form-aliasUsuario" value="${u?.aliasUsuario || ''}" required class="w-full p-3 border border-gray-300 rounded-lg mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tel√©fono (ID Usuario)</label>
                            <input type="tel" id="form-idUsuario" value="${u?.idUsuario || ''}" required ${u ? 'readonly' : ''} class="w-full p-3 border border-gray-300 rounded-lg mt-1 ${u ? 'bg-gray-100' : ''}" placeholder="9 cifras, ej: 600111222" pattern="[0-9]{9}">
                            ${u ? '<p class="text-xs text-gray-500 mt-1">El tel√©fono no se puede editar.</p>' : ''}
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button type="button" onclick="closeForm()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
                        </div>
                    `;
                }
            }
            
            document.getElementById('form-modal').classList.add('flex');
        }
				
        
        function closeForm() {
            document.getElementById('form-modal').classList.remove('flex');
        }
				// --- NUEVA FUNCI√ìN ---
				function switchGroupFormTab(type) {
						document.getElementById('form-group-type').value = type;
						
						// Pesta√±as
						document.getElementById('tab-recurrent').classList.toggle('form-tab-active', type === 'recurrent');
						document.getElementById('tab-timestamp').classList.toggle('form-tab-active', type === 'timestamp');
						
						// Contenido
						document.getElementById('form-content-recurrent').classList.toggle('hidden', type !== 'recurrent');
						document.getElementById('form-content-timestamp').classList.toggle('hidden', type !== 'timestamp');

						// Quitar 'required' de los inputs ocultos para que el form se pueda enviar
						document.getElementById('form-fechaInicio').required = (type === 'timestamp');
						document.getElementById('form-fechaFin').required = (type === 'timestamp');
						document.getElementById('form-descGrupo-timestamp').required = (type === 'timestamp');
				}
        document.getElementById('generic-form').onsubmit = async (event) => {
            event.preventDefault();
            const storeName = event.target.dataset.store;
            const id = event.target.dataset.id;
            let data = {};
            
            if (storeName === 'puertas') {
                data = {
                    id: id || crypto.randomUUID(),
                    aliasPuerta: document.getElementById('form-aliasPuerta').value,
                    idPuerta_password: document.getElementById('form-idPuerta_password').value
                    // CAMBIO: Eliminado el campo tel√©fono
                };
                await saveToDb('puertas', data);
                renderPuertasList();
								} else if (storeName === 'gruposHorarios') {
									const type = document.getElementById('form-group-type').value;
									data = { id: id || crypto.randomUUID(), type: type };

									if (type === 'recurrent') {
											const dias = [];
											document.querySelectorAll('.dia-toggle').forEach(btn => {
													if (btn.classList.contains('bg-indigo-100')) {
															dias.push(parseInt(btn.dataset.day));
													}
											});
											data.descGrupo = document.getElementById('form-descGrupo-recurrent').value || 'Horario recurrente';
											data.dias = dias;
											data.horaInicio = document.getElementById('form-horaInicio').value;
											data.horaFin = document.getElementById('form-horaFin').value;
									} else { // type === 'timestamp'
											data.descGrupo = document.getElementById('form-descGrupo-timestamp').value;
											data.fechaInicio = document.getElementById('form-fechaInicio').value;
											data.fechaFin = document.getElementById('form-fechaFin').value;
											
											// Validar fechas
											const tsInicio = new Date(data.fechaInicio).getTime();
											const tsFin = new Date(data.fechaFin).getTime();
											if (tsFin <= tsInicio) {
													alert('La fecha de fin debe ser posterior a la fecha de inicio.');
													return;
											}
									}
									
									await saveToDb('gruposHorarios', data);
									renderGruposList();
            } else if (storeName === 'usuarios') {
                const idUsuario = document.getElementById('form-idUsuario').value;
                if (!/^[0-9]{9}$/.test(idUsuario)) {
                    alert("El tel√©fono debe tener 9 cifras.");
                    return;
                }
                data = {
                    idUsuario: idUsuario, // La clave es el tel√©fono
                    aliasUsuario: document.getElementById('form-aliasUsuario').value
                };
                await saveToDb('usuarios', data);
                renderUsuariosList();
            }
            
            closeForm();
        };

        // Renders
        async function renderPuertasList() {
            const items = await getAllFromDb('puertas');
            const list = document.getElementById('puertas-list');
            list.innerHTML = items.map(p => `
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div>
                        <div class="font-medium text-gray-900">${p.aliasPuerta}</div>
                        <!-- CAMBIO: Eliminado el Tel: -->
                        <div class="text-sm text-gray-500">ID: ${p.idPuerta_password}</div>
                    </div>
                    <div class="space-x-2 flex-shrink-0">
                        <button onclick="showForm('puertas', '${p.id}')" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z" /></svg></button>
                        <button onclick="deleteFromDb('puertas', '${p.id}', renderPuertasList)" class="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </div>
            `).join('');
            if (items.length === 0) list.innerHTML = `<p class="text-gray-500 text-center">No hay puertas. A√±ade una para empezar.</p>`;
        }
        
				async function renderGruposList() {
						const items = await getAllFromDb('gruposHorarios');
						const list = document.getElementById('grupos-list');
						const diasMap = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

						list.innerHTML = items.map(g => {

								let detallesHtml = '';

								// CAMBIO: Comprobar el tipo de grupo
								if (g.type === 'timestamp') {
										// Es un permiso de Fecha √önica
										const inicio = new Date(g.fechaInicio).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
										const fin = new Date(g.fechaFin).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
										detallesHtml = `
												<div class="text-sm text-gray-500">
														<span class="font-medium text-indigo-700">[FECHA √öNICA]</span>
														<span class="block text-xs">De: ${inicio} | Hasta: ${fin}</span>
												</div>
										`;
								} else {
										// Es un permiso Recurrente (l√≥gica antigua)
										const diasStr = g.dias.sort((a,b) => a - b).map(d => diasMap[d]).join(', ');
										detallesHtml = `
												<div class="text-sm text-gray-500">${diasStr} (${g.horaInicio} - ${g.horaFin})</div>
										`;
								}

								return `
								<div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200">
										<div>
												<div class="font-medium text-gray-900">${g.descGrupo}</div>
												${detallesHtml} </div>
										<div class="space-x-2 flex-shrink-0">
												<button onclick="showForm('gruposHorarios', '${g.id}')" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z" /></svg></button>
												<button onclick="deleteFromDb('gruposHorarios', '${g.id}', renderGruposList)" class="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
										</div>
								</div>
						`}).join('');

						 if (items.length === 0) list.innerHTML = `<p class="text-gray-500 text-center">No hay grupos. A√±ade uno para empezar.</p>`;
				}
        
        async function renderUsuariosList(filter = '') {
            let items = await getAllFromDb('usuarios');
            if (filter) {
                items = items.filter(u => u.aliasUsuario.toLowerCase().includes(filter.toLowerCase()) || u.idUsuario.includes(filter));
            }
            const list = document.getElementById('usuarios-list');
            list.innerHTML = items.map(u => `
                <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <div onclick="showUserDetail('${u.idUsuario}')" class="cursor-pointer">
                        <div class="font-medium text-gray-900">${u.aliasUsuario}</div>
                        <div class="text-sm text-gray-500">${u.idUsuario}</div>
                    </div>
                    <div class="space-x-2 flex-shrink-0">
                        <button onclick="showForm('usuarios', '${u.idUsuario}')" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z" /></svg></button>
                        <button onclick="deleteFromDb('usuarios', '${u.idUsuario}', renderUsuariosList)" class="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    </div>
                </div>
            `).join('');
            if (items.length === 0) list.innerHTML = `<p class="text-gray-500 text-center">No hay usuarios. A√±ade uno para empezar.</p>`;
        }
        
        // Listener para la barra de b√∫squeda en Admin Usuarios
        document.getElementById('admin-user-search').addEventListener('input', (e) => {
            renderUsuariosList(e.target.value);
        });
        
				// --- VERSI√ìN TOTALMENTE NUEVA DE showUserDetail ---
				async function showUserDetail(idUsuario) {
						const user = await getFromDb('usuarios', idUsuario);
						document.getElementById('detail-user-alias').textContent = user.aliasUsuario;
						document.getElementById('detail-user-tel').textContent = user.idUsuario;
						
						// Buscar permisos
						const permisos = await getFromDbByIndex('permisosAsignados', 'usuarioIdx', idUsuario);
						
						// IDs de las nuevas listas
						const listRecurrent = document.getElementById('detail-user-permisos-recurrentes');
						const listTimestamp = document.getElementById('detail-user-permisos-timestamp');
						listRecurrent.innerHTML = '';
						listTimestamp.innerHTML = '';

						if (permisos.length === 0) {
								listRecurrent.innerHTML = `<p class="text-gray-500 text-sm">Este usuario no tiene permisos asignados en la app.</p>`;
								showSubPage('page-user-detail');
								return;
						}
						
						// Cargar los nombres de puertas y grupos
						const puertas = await getAllFromDb('puertas');
						const grupos = await getAllFromDb('gruposHorarios');
						const puertasMap = new Map(puertas.map(p => [p.id, p.aliasPuerta]));
						const gruposMap = new Map(grupos.map(g => [g.id, g.descGrupo]));
						
						const ahora_ts = Math.floor(new Date().getTime() / 1000); // Timestamp actual

						for (const p of permisos) {
								const puertaNombre = puertasMap.get(p.idPuerta) || 'Puerta Desconocida';
								const grupo = await getFromDb('gruposHorarios', p.idGrupo); // Obtenemos el objeto grupo completo
								
								if (!grupo) {
										 listRecurrent.innerHTML += `<div class="p-3 bg-gray-50 rounded-lg"><div class="font-medium text-red-700">${puertaNombre}</div><p class="text-sm text-red-600">Error: Horario (ID: ${p.idGrupo}) no encontrado. Pudo ser borrado.</p></div>`;
										 continue;
								}

								if (grupo.type === 'timestamp') {
										// --- RENDERIZAR PERMISO DE FECHA √öNICA ---
										const tsInicio = Math.floor(new Date(grupo.fechaInicio).getTime() / 1000);
										const tsFin = Math.floor(new Date(grupo.fechaFin).getTime() / 1000);
										
										const fechaInicioStr = new Date(tsInicio * 1000).toLocaleString('es-ES');
										const fechaFinStr = new Date(tsFin * 1000).toLocaleString('es-ES');

										let estadoTag = '';
										let deleteButtonHtml = '';

										if (ahora_ts < tsInicio) {
												estadoTag = '<span class="text-xs font-medium bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Programado</span>';
										} else if (ahora_ts > tsFin) {
												estadoTag = '<span class="text-xs font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">Caducado</span>';
												// Si est√° caducado, mostrar bot√≥n de borrar
												deleteButtonHtml = `
														<button onclick="deletePermissionRecord(${p.id}, '${p.idUsuario}')" 
																		class="p-1 text-gray-400 hover:text-red-600 rounded-full hover:bg-gray-100 transition-colors"
																		title="Borrar del historial">
																<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
														</button>
												`;
										} else {
												estadoTag = '<span class="text-xs font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Activo</span>';
										}

										listTimestamp.innerHTML += `
												<div class="p-3 bg-white rounded-lg border border-gray-200">
														<div class="flex justify-between items-center mb-1">
																<div class="font-medium text-gray-800">${puertaNombre}</div>
																${estadoTag}
														</div>
														<p class="text-sm text-gray-500 mb-2">${grupo.descGrupo}</p>
														<div class="flex justify-between items-end">
																<p class="text-sm text-gray-600">
																		<span class="text-xs block">Desde: ${fechaInicioStr}</span>
																		<span class="text-xs block">Hasta: ${fechaFinStr}</span>
																</p>
																${deleteButtonHtml}
														</div>
												</div>
										`;

								} else {
										// --- RENDERIZAR PERMISO RECURRENTE (como antes) ---
										const diasMap = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
										const diasStr = grupo.dias.sort((a,b) => a - b).map(d => diasMap[d]).join(', ');
										
										listRecurrent.innerHTML += `
												<div class="p-3 bg-gray-50 rounded-lg">
														<div class="font-medium text-gray-800">${puertaNombre}</div>
														<p class="text-sm text-gray-600">${grupo.descGrupo} (${diasStr} / ${grupo.horaInicio} - ${grupo.horaFin})</p>
												</div>
										`;
								}
						}
						
						// Si una lista est√° vac√≠a, mostrar mensaje
						if (listRecurrent.innerHTML === '') {
								listRecurrent.innerHTML = `<p class="text-gray-500 text-sm px-3">Sin permisos recurrentes.</p>`;
						}
						if (listTimestamp.innerHTML === '') {
								listTimestamp.innerHTML = `<p class="text-gray-500 text-sm px-3">Sin permisos de fecha √∫nica.</p>`;
						}

						showSubPage('page-user-detail');
				}

        // --- L√ìGICA DE WORKFLOW (Acciones) ---
        
        async function startWorkflow(action) {
            currentAction = action;
            currentWorkflow = { puertaId: null, grupoId: null, usuarios: [] };
            
            if (action === 'ADD') {
                document.getElementById('workflow-title').textContent = 'Asignar permisos';
                document.getElementById('workflow-action-button').textContent = 'Generar SMS de configuraci√≥n(revisa tus tarifas de env√≠o de sms)';
                document.getElementById('workflow-action-button').classList.remove('bg-red-600', 'hover:bg-red-700');
                document.getElementById('workflow-action-button').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                document.getElementById('workflow-title').textContent = 'Revocar permisos';
                document.getElementById('workflow-action-button').textContent = 'Generar SMS de configuraci√≥n(revisa tus tarifas de env√≠o de sms)';
                document.getElementById('workflow-action-button').classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                document.getElementById('workflow-action-button').classList.add('bg-red-600', 'hover:bg-red-700');
            }
            showSubPage('page-workflow');
        }

        async function renderWorkflowPage() {
            // Rellenar selects
            const puertas = await getAllFromDb('puertas');
            const grupos = await getAllFromDb('gruposHorarios');
            const selectPuerta = document.getElementById('workflow-select-puerta');
            const selectGrupo = document.getElementById('workflow-select-horario');
            
            selectPuerta.innerHTML = puertas.map(p => `<option value="${p.id}">${p.aliasPuerta}</option>`).join('');
            selectGrupo.innerHTML = grupos.map(g => `<option value="${g.id}">${g.descGrupo}</option>`).join('');
            
            // Asignar listeners a los selects y b√∫squeda para re-renderizar la lista
            selectPuerta.onchange = renderWorkflowUserList;
            selectGrupo.onchange = renderWorkflowUserList;
            document.getElementById('workflow-search').oninput = renderWorkflowUserList;
            
            // Renderizar lista de usuarios
            renderWorkflowUserList();
        }

        async function renderWorkflowUserList() {
            const puertaId = document.getElementById('workflow-select-puerta').value;
            const grupoId = document.getElementById('workflow-select-horario').value;
            const searchTerm = document.getElementById('workflow-search').value.toLowerCase();
            
            // Resetear selecci√≥n si cambia el contexto
            if (puertaId !== currentWorkflow.puertaId || grupoId !== currentWorkflow.grupoId) {
                currentWorkflow.usuarios = [];
            }
            currentWorkflow.puertaId = puertaId;
            currentWorkflow.grupoId = grupoId;
            
            let allUsers = await getAllFromDb('usuarios');
            const allPermisos = await getAllFromDb('permisosAsignados');
            
            // Crear un Set de permisos para b√∫squeda r√°pida
            const permisoSet = new Set(allPermisos.map(p => `${p.idUsuario}_${p.idPuerta}_${p.idGrupo}`));
            
            const userListDiv = document.getElementById('workflow-user-list');
            userListDiv.innerHTML = '';
            
            // Filtrar usuarios
            if (searchTerm) {
                allUsers = allUsers.filter(u => u.aliasUsuario.toLowerCase().includes(searchTerm) || u.idUsuario.includes(searchTerm));
            }
            
            if (allUsers.length === 0) {
                 userListDiv.innerHTML = `<p class="text-gray-500 text-center">No hay usuarios que coincidan.</p>`;
            }

            allUsers.forEach(user => {
                const permisoKey = `${user.idUsuario}_${puertaId}_${grupoId}`;
                const hasPerm = permisoSet.has(permisoKey);
                const isSelected = currentWorkflow.usuarios.includes(user.idUsuario);
                
                let warning = '';
                if (currentAction === 'ADD' && hasPerm) {
                    warning = `<div class="text-xs font-medium text-yellow-700 mt-1">‚ö†Ô∏è (Ya asignado)</div>`;
                }
                if (currentAction === 'DEL' && !hasPerm) {
                    warning = `<div class="text-xs font-medium text-gray-500 mt-1">‚ÑπÔ∏è (No asignado)</div>`;
                }
                
                userListDiv.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm">
                        <div>
                            <div class="font-medium text-gray-900">${user.aliasUsuario}</div>
                            <div class="text-sm text-gray-500">${user.idUsuario}</div>
                            ${warning}
                        </div>
                        <input type="checkbox" data-userid="${user.idUsuario}" ${isSelected ? 'checked' : ''} onchange="toggleUserInWorkflow(this)" class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    </div>
                `;
            });
            
            updateWorkflowCount();
        }

        function toggleUserInWorkflow(checkbox) {
            const userId = checkbox.dataset.userid;
            const isChecked = checkbox.checked;
            
            if (isChecked) {
                // A√±adir usuario
                if (currentWorkflow.usuarios.length >= 10) {
                    alert("No puedes seleccionar m√°s de 10 usuarios por SMS.");
                    checkbox.checked = false;
                    return;
                }
                if (!currentWorkflow.usuarios.includes(userId)) {
                    currentWorkflow.usuarios.push(userId);
                }
            } else {
                // Quitar usuario
                currentWorkflow.usuarios = currentWorkflow.usuarios.filter(id => id !== userId);
            }
            updateWorkflowCount();
        }
        
        function updateWorkflowCount() {
             document.getElementById('workflow-user-count').textContent = `${currentWorkflow.usuarios.length} / 10`;
        }

        // --- L√ìGICA DE SMS Y SINCRONIZACI√ìN ---
        
        /*
		async function generateSmsAndConfirm() {
            if (currentWorkflow.usuarios.length === 0) {
                alert("Debes seleccionar al menos un usuario.");
                return;
            }
            
            // 1. Obtener datos
            const puerta = await getFromDb('puertas', currentWorkflow.puertaId);
            const grupo = await getFromDb('gruposHorarios', currentWorkflow.grupoId);
						let horarioStr = '';
            // --- NUEVA L√ìGICA DE HORARIO ---
            if (grupo.type === 'timestamp') {
                // TIPO 1: Fecha √önica (Timestamp)
                // Convertir datetime-local a timestamp UNIX (en segundos)
                const tsInicio = Math.floor(new Date(grupo.fechaInicio).getTime() / 1000);
                const tsFin = Math.floor(new Date(grupo.fechaFin).getTime() / 1000);
                
                // Formato: TS;START_TIMESTAMP;END_TIMESTAMP
                horarioStr = `TS;${tsInicio};${tsFin}`;
                
            } else {
                // TIPO 2: Recurrente (el antiguo)
                const diasMap = ['1', '2', '3', '4', '5', '6', '7']; // Asumiendo que 0=L, 6=D
                const diasStr = grupo.dias.sort((a,b) => a - b).map(d => diasMap[d]).join('');
                
                // Formato: DIAS;HH-HH
                horarioStr = `${diasStr};${grupo.horaInicio}-${grupo.horaFin}`;
            }
            // --- FIN DE L√ìGICA DE HORARIO ---
            
            const usuariosStr = currentWorkflow.usuarios.join('\n');
            
            // El formato del SMS ahora usa el 'horarioStr' din√°mico
            const smsBody = `${puerta.idPuerta_password}\n${horarioStr}\n${currentAction}\n${usuariosStr}`;
            
            // 3. Lanzar SMS
            // Usamos `sms:` que funciona en Android e iOS.
            // CAMBIO: Eliminado el 'recipient'. Ahora es `sms:?`
            const uri = `sms:?body=${encodeURIComponent(smsBody)}`;
            
            // Guardar datos para la sincronizaci√≥n
            pendingSyncData = {
                action: currentAction,
                permisos: currentWorkflow.usuarios.map(userId => ({
                    idUsuario: userId,
                    idPuerta: currentWorkflow.puertaId,
                    idGrupo: currentWorkflow.grupoId
                }))
            };
            
            // Abrir app de SMS
            window.location.href = uri;
            
            // 4. Mostrar Modal de Sincronizaci√≥n
            // Retraso para dar tiempo a que se abra la app de SMS
            setTimeout(() => {
                showSyncModal();
            }, 1000); 
        }*/
		async function generateSmsAndConfirm() {
				if (currentWorkflow.usuarios.length === 0) {
					alert("Debes seleccionar al menos un usuario.");
					return;
				}
				
				// 1. Obtener datos
				const puerta = await getFromDb('puertas', currentWorkflow.puertaId);
				const grupo = await getFromDb('gruposHorarios', currentWorkflow.grupoId);
				let horarioStr = '';

				// --- L√ìGICA DE HORARIO (ACTUALIZADA) ---
				if (grupo.type === 'timestamp') {
					// TIPO 1: Fecha √önica (Formato PIC Delimitado)
					
					// Usamos la funci√≥n helper que acabamos de a√±adir
					const picInicio = formatForPICDelimited(grupo.fechaInicio);
					const picFin = formatForPICDelimited(grupo.fechaFin);
					
					// CAMBIO: Formato: TS;YY;MM;DD;HH;MI;YY;MM;DD;HH;MI
					horarioStr = `TS;${picInicio};${picFin}`;
					
				} else {
					// TIPO 2: Recurrente (Formato PIC Delimitado)
					const diasMap = ['1', '2', '3', '4', '5', '6', '7']; // 0=L -> '1', 6=D -> '7'
					const diasStr = grupo.dias.sort((a,b) => a - b).map(d => diasMap[d]).join('');
					
					// CAMBIO: Separamos las horas y minutos
					const [startHH, startMM] = grupo.horaInicio.split(':'); // "08:00" -> ["08", "00"]
					const [endHH, endMM] = grupo.horaFin.split(':');       // "17:00" -> ["17", "00"]

					// CAMBIO: Formato: DIAS;HH;MM;HH;MM
					horarioStr = `${diasStr};${startHH};${startMM};${endHH};${endMM}`;
				}
				// --- FIN DE L√ìGICA DE HORARIO ---
				
				const usuariosStr = currentWorkflow.usuarios.join('\n');
				
				// El formato del SMS ahora usa el 'horarioStr' din√°mico
				const smsBody = `${puerta.idPuerta_password}\n${horarioStr}\n${currentAction}\n${usuariosStr}`;
				
				// 3. Lanzar SMS
				const uri = `sms:?body=${encodeURIComponent(smsBody)}`;
				
				// Guardar datos para la sincronizaci√≥n
				pendingSyncData = {
					action: currentAction,
					permisos: currentWorkflow.usuarios.map(userId => ({
						idUsuario: userId,
						idPuerta: currentWorkflow.puertaId,
						idGrupo: currentWorkflow.grupoId
					}))
				};
				
				// Abrir app de SMS
				window.location.href = uri;
				
				// 4. Mostrar Modal de Sincronizaci√≥n
				setTimeout(() => {
					showSyncModal();
				}, 1000); 
			}

        function showSyncModal() {
            document.getElementById('sync-modal').classList.add('flex');
            document.getElementById('sync-button-yes').onclick = syncData;
            document.getElementById('sync-button-no').onclick = closeSyncModal;
        }
        
        function closeSyncModal() {
            document.getElementById('sync-modal').classList.remove('flex');
            pendingSyncData = null;
            // Resetear el workflow para una nueva acci√≥n
            currentWorkflow.usuarios = [];
            renderWorkflowUserList();
        }
        /*
        async function syncData() {
            if (!pendingSyncData) {
                closeSyncModal();
                return;
            }
            
            const { action, permisos } = pendingSyncData;
            
            if (action === 'ADD') {
                for (const p of permisos) {
                    await saveToDb('permisosAsignados', p); // .put se encarga de duplicados
                }
            } else if (action === 'DEL') {
                for (const p of permisos) {
                    // Encontrar el permiso exacto y borrarlo
                    const key = [p.idUsuario, p.idPuerta, p.idGrupo];
                    await deleteFromDbByIndex('permisosAsignados', 'permisoIdx', key);
                }
            }
            
            alert("Sincronizaci√≥n completada.");
            closeSyncModal();
        }
				*/
				async function syncData() {
						if (!pendingSyncData) {
								closeSyncModal();
								return;
						}
						
						const { action, permisos } = pendingSyncData;
						
						// CAMBIO: Envolvemos todo en un try...catch...finally
						try {
								if (action === 'ADD') {
										for (const p of permisos) {
												
												// CAMBIO: Primero comprobamos si ya existe
												const key = [p.idUsuario, p.idPuerta, p.idGrupo];
												// Usamos 'getFromDbByIndex' que ya ten√≠as
												const existing = await getFromDbByIndex('permisosAsignados', 'permisoIdx', key); 
												
												// Solo guardamos si no existe (existing.length === 0)
												if (existing.length === 0) {
														await saveToDb('permisosAsignados', p);
												} else {
														console.log("Permiso ya existente, omitiendo: ", p);
												}
										}
								} else if (action === 'DEL') {
										for (const p of permisos) {
												// Encontrar el permiso exacto y borrarlo
												const key = [p.idUsuario, p.idPuerta, p.idGrupo];
												await deleteFromDbByIndex('permisosAsignados', 'permisoIdx', key);
										}
								}
								
								alert("Sincronizaci√≥n completada.");
								
						} catch (err) {
								// Si algo inesperado falla, lo mostramos...
								console.error("Error durante la sincronizaci√≥n:", err);
								alert("Ocurri√≥ un error inesperado al sincronizar.");
						} finally {
								// ...pero nos aseguramos de CERRAR el modal SIEMPRE.
								closeSyncModal();
						}
				}

        // --- API DE CONTACTOS ---
        async function loadContact() {
            if (!('contacts' in navigator && 'ContactsManager' in window)) {
                alert('Error: La API de Contactos no est√° soportada en este navegador (ej. Safari en iOS) o la p√°gina no es segura (no es HTTPS).');
                return;
            }
            try {
                const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false });
                if (contacts.length > 0) {
                    const contact = contacts[0];
                    if (contact.name && contact.name.length > 0) {
                        document.getElementById('form-aliasUsuario').value = contact.name[0];
                    }
                    if (contact.tel && contact.tel.length > 0) {
                        const cleanTel = contact.tel[0].replace(/[\s-()A-Za-z]/g, '').slice(-9); // Tomar solo los √∫ltimos 9 d√≠gitos
                        document.getElementById('form-idUsuario').value = cleanTel;
                    }
                }
            } catch (ex) {
                console.error('Error al seleccionar contacto:', ex);
                alert('No se pudo acceder a los contactos. Aseg√∫rate de que la p√°gina se sirve por HTTPS.');
            }
        }
        
        // --- COPIA DE SEGURIDAD ---
        async function exportData() {
            showLoading('Exportando datos...');
            try {
                const backup = {
                    puertas: await getAllFromDb('puertas'),
                    gruposHorarios: await getAllFromDb('gruposHorarios'),
                    usuarios: await getAllFromDb('usuarios'),
                    permisosAsignados: await getAllFromDb('permisosAsignados')
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `gestor_puertas_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                hideLoading();
            } catch (err) {
                console.error('Error al exportar:', err);
                alert('Error al exportar los datos.');
                hideLoading();
            }
        }
				// --- NUEVA FUNCI√ìN PARA BORRAR REGISTROS ---
				async function deletePermissionRecord(permisoId, idUsuario) {
						// 'permisoId' es el ID autoincremental de la tabla 'permisosAsignados'
						
						if (!confirm("¬øQuitar este registro caducado del historial?")) return;

						try {
								const tx = db.transaction('permisosAsignados', 'readwrite');
								const store = tx.objectStore('permisosAsignados');
								
								// Usamos la clave primaria 'id' que es autoincremental
								const request = store.delete(permisoId); 
								
								request.onsuccess = () => {
										console.log('Registro de permiso borrado:', permisoId);
										// Refrescar la vista de detalles del usuario para ver el cambio
										showUserDetail(idUsuario);
								};
								request.onerror = (e) => {
										console.error('Error al borrar el registro:', e.target.error);
										alert('No se pudo borrar el registro.');
								};
								
						} catch (err) {
								console.error('Error al borrar registro:', err);
						}
				}

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("¬øSeguro? Esto borrar√° todos los datos actuales y los reemplazar√° con los del fichero.")) {
                event.target.value = null; // Resetear input
                return;
            }
            
            showLoading('Importando datos...');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Limpiar todas las tiendas
                    await clearDbStore('puertas');
                    await clearDbStore('gruposHorarios');
                    await clearDbStore('usuarios');
                    await clearDbStore('permisosAsignados');
                    
                    // Rellenar todas las tiendas
                    if (data.puertas) {
                        for (const item of data.puertas) await saveToDb('puertas', item);
                    }
                    if (data.gruposHorarios) {
                        for (const item of data.gruposHorarios) await saveToDb('gruposHorarios', item);
                    }
                    if (data.usuarios) {
                        for (const item of data.usuarios) await saveToDb('usuarios', item);
                    }
                    if (data.permisosAsignados) {
                        for (const item of data.permisosAsignados) await saveToDb('permisosAsignados', item);
                    }
                    
                    hideLoading();
                    alert('Importaci√≥n completada con √©xito.');
                    // Recargar las vistas
                    renderPuertasList();
                    renderGruposList();
                    renderUsuariosList();
                    
                } catch (err) {
                    console.error('Error al importar:', err);
                    alert('Error: El fichero de importaci√≥n parece estar da√±ado o no es v√°lido.');
                    hideLoading();
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Resetear input
        }

        // --- HELPERS DE DB (Promisified) ---
        
        function saveToDb(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        function getFromDb(storeName, key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getAllFromDb(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        function getFromDbByIndex(storeName, indexName, query) {
             return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.getAll(query);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        function deleteFromDb(storeName, key, renderCallback) {
            if (!confirm("¬øEst√°s seguro de que quieres borrar este elemento?")) return;
            
            // Si borramos un usuario, puerta u horario, tambi√©n borramos sus permisos
            if (storeName === 'usuarios') deleteRelatedPermisos('idUsuario', key);
            if (storeName === 'puertas') deleteRelatedPermisos('idPuerta', key);
            if (storeName === 'gruposHorarios') deleteRelatedPermisos('idGrupo', key);
            
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.delete(key);
            request.onsuccess = () => {
                if (renderCallback) renderCallback();
            };
            request.onerror = (e) => console.error('Error al borrar:', e.target.error);
        }
        
        async function deleteRelatedPermisos(keyType, keyValue) {
            // CORREGIDO: La l√≥gica del indexName ahora es correcta
            const indexName = keyType === 'idUsuario' ? 'usuarioIdx' : (keyType === 'idPuerta' ? 'puertaIdx' : 'grupoIdx');
            const permisos = await getFromDbByIndex('permisosAsignados', indexName, keyValue);
            
            const tx = db.transaction('permisosAsignados', 'readwrite');
            const store = tx.objectStore('permisosAsignados');
            permisos.forEach(p => {
                // p.id es la clave autoincremental
                store.delete(p.id);
            });
        }

        
        function deleteFromDbByIndex(storeName, indexName, query) {
             return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.getKey(query); // Obtener la clave primaria del permiso
                request.onsuccess = () => {
                    if (request.result) {
                        store.delete(request.result).onsuccess = resolve;
                    } else {
                        resolve(); // No se encontr√≥, no hay nada que borrar
                    }
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        function clearDbStore(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }
        

        // --- INICIAR LA APP ---
        window.onload = initDB;

    </script>
</body>
</html>



